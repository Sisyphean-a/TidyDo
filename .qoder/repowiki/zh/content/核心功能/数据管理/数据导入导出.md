# 数据导入导出

<cite>
**Referenced Files in This Document**  
- [dataService.js](file://src/services/dataService.js)
- [ConfigDialog.vue](file://src/model/ConfigDialog.vue)
- [todoService.js](file://src/services/todoService.js)
</cite>

## 目录
1. [数据导入导出](#数据导入导出)
2. [核心功能概述](#核心功能概述)
3. [数据导出机制](#数据导出机制)
4. [数据导入与合并策略](#数据导入与合并策略)
5. [文件系统API与降级处理](#文件系统api与降级处理)
6. [用户界面工作流程](#用户界面工作流程)
7. [错误处理与验证](#错误处理与验证)

## 核心功能概述

`DataService` 类提供了完整的数据备份与恢复功能，支持数据的导出和导入操作。该服务通过 `exportAllData` 和 `importData` 静态方法实现核心功能，确保用户数据的安全性和可移植性。数据导出采用版本化结构设计，包含版本号、时间戳和实际数据三个核心字段，便于后续的数据兼容性管理和追溯。

**Section sources**
- [dataService.js](file://src/services/dataService.js#L13-L35)
- [dataService.js](file://src/services/dataService.js#L46-L86)

## 数据导出机制

`DataService.exportAllData` 方法负责将应用中的所有数据打包导出。该方法首先创建一个包含版本信息和时间戳的导出对象，然后通过 `idb-keyval` 库获取所有存储的键值对，将它们整合到导出对象的 `data` 字段中。

```mermaid
flowchart TD
A[开始导出] --> B[创建导出对象]
B --> C[设置版本号和时间戳]
C --> D[获取所有存储键]
D --> E[遍历所有键]
E --> F[读取每个键的值]
F --> G[添加到导出数据]
G --> H{是否还有更多键?}
H --> |是| E
H --> |否| I[返回导出对象]
J[导出失败] --> K[记录错误]
K --> L[抛出异常]
A --> J
E --> J
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L13-L35)

**Section sources**
- [dataService.js](file://src/services/dataService.js#L13-L35)

## 数据导入与合并策略

`DataService.importData` 方法实现了灵活的数据导入功能，支持两种操作模式：清除现有数据（覆盖模式）和合并数据（保留模式）。在合并模式下，系统会智能地处理数组类型的数据，避免重复项的产生。

### 智能合并算法

对于待办事项和分类数据，系统采用基于ID的去重合并策略。该策略通过 `DataService.mergeArrayData` 方法实现，具体流程如下：

```mermaid
flowchart TD
A[开始合并] --> B{是否为待办或分类数据?}
B --> |是| C[提取现有数据的ID集合]
C --> D[过滤新数据中ID已存在的项]
D --> E[合并现有数据和唯一新数据]
E --> F[返回合并结果]
B --> |否| G[直接替换为新数据]
G --> F
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L89-L99)

**Section sources**
- [dataService.js](file://src/services/dataService.js#L46-L86)
- [dataService.js](file://src/services/dataService.js#L89-L99)

#### 选项行为差异

| 选项 | 行为 | 应用场景 |
|------|------|----------|
| `clearExisting: true` | 清除所有现有数据后导入 | 数据恢复、系统重置 |
| `mergeData: true` | 智能合并数据，保留现有项 | 数据迁移、多设备同步 |

## 文件系统API与降级处理

`DataService` 实现了现代 File System Access API 与传统 Blob 下载方式的无缝集成，确保在不同浏览器环境下的兼容性。

### 降级处理逻辑

```mermaid
sequenceDiagram
participant UI as 用户界面
participant DataService as DataService
participant Browser as 浏览器
UI->>DataService : 请求保存文件
DataService->>Browser : 检查showSaveFilePicker支持
alt 支持现代API
Browser-->>DataService : API可用
DataService->>Browser : 调用showSaveFilePicker
alt 用户选择位置
Browser-->>DataService : 返回文件句柄
DataService->>Browser : 创建可写流
DataService->>Browser : 写入JSON数据
DataService->>Browser : 关闭流
DataService-->>UI : 保存成功
else 用户取消
DataService-->>UI : 操作取消
end
else 不支持现代API
Browser-->>DataService : API不可用
DataService->>Browser : 创建Blob和下载链接
DataService->>Browser : 触发下载
DataService-->>UI : 下载完成
end
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L130-L173)
- [dataService.js](file://src/services/dataService.js#L102-L121)

**Section sources**
- [dataService.js](file://src/services/dataService.js#L102-L173)

## 用户界面工作流程

`ConfigDialog` 组件提供了用户友好的数据管理界面，允许用户通过可视化操作完成数据备份和恢复。

### 数据备份流程

```mermaid
flowchart TD
A[打开配置对话框] --> B[切换到数据管理标签]
B --> C[点击导出所有数据]
C --> D{支持现代文件系统API?}
D --> |是| E[显示文件保存选择器]
E --> F[用户选择保存位置]
F --> G[使用saveFileWithSystemAPI保存]
G --> H[显示成功提示]
D --> |否| I[使用downloadAsJSON触发下载]
I --> H
```

### 数据恢复流程

```mermaid
flowchart TD
A[选择JSON文件] --> B{文件格式验证}
B --> |无效| C[显示错误提示]
B --> |有效| D[读取文件内容]
D --> E{解析JSON}
E --> |失败| F[显示格式错误]
E --> |成功| G[选择导入模式]
G --> H{合并或覆盖?}
H --> |合并| I[调用importData(mergeData=true)]
H --> |覆盖| J[确认操作]
J --> K[调用importData(clearExisting=true)]
I --> L[更新应用数据]
K --> L
L --> M[显示结果提示]
```

**Diagram sources**
- [ConfigDialog.vue](file://src/model/ConfigDialog.vue#L400-L450)
- [ConfigDialog.vue](file://src/model/ConfigDialog.vue#L452-L550)

**Section sources**
- [ConfigDialog.vue](file://src/model/ConfigDialog.vue#L400-L550)

## 错误处理与验证

系统实现了多层次的错误处理和数据验证机制，确保数据操作的可靠性和用户体验。

### 文件读取验证

`DataService.readJSONFile` 方法在读取文件时执行严格的验证：

1. **文件存在性检查**：确保用户已选择文件
2. **文件格式验证**：检查文件扩展名是否为 `.json`
3. **JSON语法解析**：验证文件内容是否为有效的JSON格式
4. **数据结构验证**：确保导入的数据包含必要的 `data` 字段

```mermaid
flowchart TD
A[开始读取文件] --> B{文件存在?}
B --> |否| C[拒绝: 未选择文件]
B --> |是| D{JSON文件?}
D --> |否| E[拒绝: 文件格式错误]
D --> |是| F[读取文件内容]
F --> G{解析JSON}
G --> |失败| H[拒绝: 格式错误]
G --> |成功| I[解析成功]
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L207-L236)

**Section sources**
- [dataService.js](file://src/services/dataService.js#L207-L236)