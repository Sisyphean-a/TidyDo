# 数据初始化

<cite>
**Referenced Files in This Document**   
- [useAppStore.js](file://src/stores/useAppStore.js)
- [configService.js](file://src/services/configService.js)
- [appService.js](file://src/services/appService.js)
- [useConfig.js](file://src/composables/useConfig.js)
- [main.js](file://src/main.js)
- [todoService.js](file://src/services/todoService.js)
</cite>

## 目录
1. [应用启动流程](#应用启动流程)
2. [核心状态初始化](#核心状态初始化)
3. [配置数据合并机制](#配置数据合并机制)
4. [分类选择逻辑](#分类选择逻辑)
5. [系统配置初始化](#系统配置初始化)
6. [状态重置机制](#状态重置机制)

## 应用启动流程

应用的启动流程由 `AppService` 统一管理，确保初始化过程的正确时序和依赖关系。在 `main.js` 中，应用通过调用 `AppService.initializeApp()` 方法启动，该方法负责协调所有基础服务的初始化。

```mermaid
sequenceDiagram
participant Main as main.js
participant AppService as AppService
participant ConfigService as ConfigService
participant GlobalConfig as globalConfig
participant TodoService as todoService
participant Stores as Stores
Main->>AppService : initializeApp()
AppService->>AppService : 防止重复初始化
AppService->>AppService : 并行初始化基础服务
AppService->>ConfigService : getConfig()
AppService->>GlobalConfig : initializeConfig()
AppService->>TodoService : initializeDefaultData()
AppService->>Stores : initializeStores()
Stores->>useCategoriesStore : loadCategories()
Stores->>useTodosStore : loadTodos()
Stores->>useSimpleTodosStore : loadSimpleTodos()
Stores->>useAppStore : initializeSelection(categories)
AppService-->>Main : 初始化完成
Main->>App : mount('#app')
```

**Diagram sources**
- [main.js](file://src/main.js#L40-L45)
- [appService.js](file://src/services/appService.js#L23-L54)

**Section sources**
- [main.js](file://src/main.js#L40-L45)
- [appService.js](file://src/services/appService.js#L23-L54)

## 核心状态初始化

`useAppStore` 是应用的核心状态管理模块，负责维护 `selectedCategoryId`、`viewMode`、`sortBy` 等关键状态的初始化和协调。这些状态在应用启动时被设置为默认值，为用户提供一致的初始体验。

```mermaid
classDiagram
class useAppStore {
+selectedCategoryId : ref
+viewAllMode : ref
+viewMode : ref
+sortBy : ref
+sortOrder : ref
+searchQuery : ref
+selectedCategory : computed
+currentTodos : computed
+tableColumns : computed
+selectCategory(category)
+handleCategoryUpdated(updatedCategories)
+enterViewAllMode()
+exitViewAllMode()
+setViewMode(mode)
+toggleViewMode()
+toggleSort(field)
+initializeSelection(categories)
+resetState()
+setSearchQuery(query)
+clearSearch()
}
class useCategoriesStore {
+categories : ref
+loadCategories()
+getCategoryById(id)
+resetState()
}
class useTodosStore {
+todos : ref
+loadTodos()
+getTodosByCategoryId(categoryId)
+resetState()
}
useAppStore --> useCategoriesStore : "依赖"
useAppStore --> useTodosStore : "依赖"
```

**Diagram sources**
- [useAppStore.js](file://src/stores/useAppStore.js#L6-L277)
- [useCategoriesStore.js](file://src/stores/useCategoriesStore.js)
- [useTodosStore.js](file://src/stores/useTodosStore.js)

**Section sources**
- [useAppStore.js](file://src/stores/useAppStore.js#L6-L277)

## 配置数据合并机制

`configService` 通过 `mergeConfig` 方法实现了强大的配置数据默认值合并机制。这一机制确保了即使应用新增了配置项，也能被正确初始化，同时保留用户已有的自定义设置。

```mermaid
flowchart TD
Start([开始合并配置]) --> CheckKey["遍历默认配置的每个键"]
CheckKey --> IsObject{"当前键的值是对象?"}
IsObject --> |是| RecursiveMerge["递归合并子对象"]
IsObject --> |否| HasUserValue{"用户配置中存在该键?"}
HasUserValue --> |是| UseUserValue["使用用户配置的值"]
HasUserValue --> |否| UseDefaultValue["使用默认配置的值"]
UseUserValue --> AddToResult
UseDefaultValue --> AddToResult
RecursiveMerge --> AddToResult
AddToResult --> NextKey["处理下一个键"]
NextKey --> CheckKey
CheckKey --> |所有键处理完毕| AddExtra["添加用户配置中额外的属性"]
AddExtra --> ReturnResult["返回合并后的配置"]
ReturnResult --> End([结束])
```

**Diagram sources**
- [configService.js](file://src/services/configService.js#L172-L205)

**Section sources**
- [configService.js](file://src/services/configService.js#L172-L205)

## 分类选择逻辑

`useAppStore` 提供了两种机制来处理分类选择：`initializeSelection` 方法在应用启动时自动选择合适的分类，而 `handleCategoryUpdated` 方法则在分类数据更新后维护选择状态。

```mermaid
sequenceDiagram
participant AppService as AppService
participant useAppStore as useAppStore
participant useCategoriesStore as useCategoriesStore
AppService->>useAppStore : initializeSelection(categories)
useAppStore->>useAppStore : 检查selectedCategoryId是否为空
useAppStore->>useAppStore : 检查categories是否存在且非空
useAppStore->>useAppStore : 设置selectedCategoryId为第一个分类的ID
useAppStore-->>AppService : 初始化完成
useCategoriesStore->>useAppStore : handleCategoryUpdated(updatedCategories)
useAppStore->>useAppStore : 检查selectedCategoryId是否为空且有分类
useAppStore->>useAppStore : 设置selectedCategoryId为第一个分类的ID
useAppStore->>useAppStore : 检查当前选中的分类是否存在
useAppStore->>useAppStore : 如果不存在，设置为第一个分类的ID或null
useAppStore-->>useCategoriesStore : 处理完成
```

**Diagram sources**
- [useAppStore.js](file://src/stores/useAppStore.js#L245-L277)
- [appService.js](file://src/services/appService.js#L98-L108)

**Section sources**
- [useAppStore.js](file://src/stores/useAppStore.js#L245-L277)

## 系统配置初始化

系统配置（如主题、语言、日期格式）的初始化由 `useConfig` 组合式函数管理。该函数通过 `globalConfig` 单例模式确保配置状态在整个应用中共享，并在应用启动时并行加载所有配置。

```mermaid
sequenceDiagram
participant AppService as AppService
participant useConfig as useConfig
participant ConfigService as ConfigService
AppService->>useConfig : initializeConfig()
useConfig->>useConfig : 检查是否已初始化
useConfig->>useConfig : 设置isLoading为true
useConfig->>ConfigService : getStatusConfig()
useConfig->>ConfigService : getPriorityConfig()
useConfig->>ConfigService : getFieldConfig()
useConfig->>ConfigService : getSystemConfig()
ConfigService-->>useConfig : 返回状态配置
ConfigService-->>useConfig : 返回优先级配置
ConfigService-->>useConfig : 返回字段配置
ConfigService-->>useConfig : 返回系统配置
useConfig->>useConfig : 更新全局响应式状态
useConfig->>useConfig : 设置isInitialized为true
useConfig->>useConfig : 设置isLoading为false
useConfig-->>AppService : 初始化完成
```

**Diagram sources**
- [useConfig.js](file://src/composables/useConfig.js#L30-L75)
- [configService.js](file://src/services/configService.js#L70-L120)

**Section sources**
- [useConfig.js](file://src/composables/useConfig.js#L30-L75)

## 状态重置机制

应用提供了两层状态重置机制：`useAppStore.resetState()` 负责重置应用界面状态，而 `ConfigService.resetToDefault()` 则负责将所有配置恢复为默认值。这两者共同构成了完整的状态管理策略。

```mermaid
classDiagram
class AppService {
+resetAppState()
+clearCache()
}
class useAppStore {
+resetState()
}
class ConfigService {
+resetToDefault()
+saveConfig(config)
+getConfig()
}
class globalConfig {
+clearCache()
+initializeConfig()
}
AppService --> useAppStore : "调用"
AppService --> ConfigService : "调用"
AppService --> globalConfig : "调用"
ConfigService --> ConfigService : "调用"
```

**Diagram sources**
- [useAppStore.js](file://src/stores/useAppStore.js#L225-L235)
- [configService.js](file://src/services/configService.js#L166-L169)
- [appService.js](file://src/services/appService.js#L142-L158)

**Section sources**
- [useAppStore.js](file://src/stores/useAppStore.js#L225-L235)
- [configService.js](file://src/services/configService.js#L166-L169)