# 数据持久化架构

<cite>
**Referenced Files in This Document**   
- [dataService.js](file://src/services/dataService.js)
- [idGenerator.js](file://src/utils/idGenerator.js)
- [errorHandler.js](file://src/utils/errorHandler.js)
- [todoService.js](file://src/services/todoService.js)
- [simpleTodoService.js](file://src/services/simpleTodoService.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
TidyDo应用采用基于IndexedDB的本地数据持久化方案，通过idb-keyval库提供轻量级键值存储。本架构文档详细阐述了数据存储、序列化、ID生成、错误处理等核心机制，以及数据导出导入、版本管理、完整性校验等高级功能，为开发者和用户提供全面的技术参考。

## 项目结构
TidyDo的数据持久化机制主要分布在`src/services`和`src/utils`目录下，采用分层架构设计，将数据访问、业务逻辑和工具功能分离。

```mermaid
graph TB
subgraph "数据服务层"
DS[dataService.js]
TS[todoService.js]
STS[simpleTodoService.js]
end
subgraph "工具层"
IG[idGenerator.js]
EH[errorHandler.js]
end
subgraph "存储引擎"
IDB[idb-keyval]
end
DS --> IDB
TS --> IDB
STS --> IDB
TS --> IG
TS --> EH
STS --> IG
STS --> EH
DS --> TS
DS --> STS
style DS fill:#4CAF50,stroke:#388E3C
style TS fill:#2196F3,stroke:#1976D2
style STS fill:#2196F3,stroke:#1976D2
style IG fill:#FF9800,stroke:#F57C00
style EH fill:#9C27B0,stroke:#7B1FA2
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js)
- [todoService.js](file://src/services/todoService.js)
- [simpleTodoService.js](file://src/services/simpleTodoService.js)
- [idGenerator.js](file://src/utils/idGenerator.js)
- [errorHandler.js](file://src/utils/errorHandler.js)

**Section sources**
- [src/services](file://src/services)
- [src/utils](file://src/utils)

## 核心组件
TidyDo的数据持久化架构由三个核心组件构成：DataService提供数据备份与恢复功能，idGenerator.js确保数据ID的全局唯一性，errorHandler.js实现统一的错误处理策略。

**Section sources**
- [dataService.js](file://src/services/dataService.js#L1-L273)
- [idGenerator.js](file://src/utils/idGenerator.js#L1-L31)
- [errorHandler.js](file://src/utils/errorHandler.js#L1-L109)

## 架构概述
TidyDo采用基于IndexedDB的客户端数据存储架构，通过idb-keyval库封装底层API，提供简洁的键值存储接口。系统定义了明确的存储键规范，使用JSON格式进行数据序列化，并通过DataService实现完整的数据导出导入功能。

```mermaid
graph TD
A[应用数据] --> B[数据序列化]
B --> C[DataService]
C --> D[Storage Operations]
D --> E[idb-keyval]
E --> F[IndexedDB]
F --> G[浏览器存储]
H[数据导入] --> C
I[数据导出] --> C
J[ID生成] --> K[idGenerator.js]
L[错误处理] --> M[errorHandler.js]
C --> K
C --> M
D --> M
style A fill:#E3F2FD,stroke:#1976D2
style B fill:#E3F2FD,stroke:#1976D2
style C fill:#4CAF50,stroke:#388E3C
style D fill:#2196F3,stroke:#1976D2
style E fill:#FFCDD2,stroke:#D32F2F
style F fill:#F3E5F5,stroke:#7B1FA2
style G fill:#E8F5E8,stroke:#388E3C
style H fill:#FFF3E0,stroke:#F57C00
style I fill:#FFF3E0,stroke:#F57C00
style J fill:#FFE082,stroke:#FF8F00
style K fill:#FF9800,stroke:#F57C00
style L fill:#CE93D8,stroke:#7B1FA2
style M fill:#9C27B0,stroke:#7B1FA2
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L1-L273)
- [idGenerator.js](file://src/utils/idGenerator.js#L1-L31)
- [errorHandler.js](file://src/utils/errorHandler.js#L1-L109)

## 详细组件分析

### DataService分析
DataService是TidyDo数据持久化的核心服务，提供完整的数据备份、恢复和迁移功能，支持现代浏览器的文件系统API和传统下载方式。

#### 数据导出功能
```mermaid
sequenceDiagram
participant UI as "用户界面"
participant DS as "DataService"
participant IDB as "idb-keyval"
UI->>DS : exportAllData()
DS->>IDB : keys()
IDB-->>DS : 所有存储键
loop 每个存储键
DS->>IDB : get(key)
IDB-->>DS : 键值数据
DS->>DS : 添加到导出对象
end
DS-->>UI : 返回导出数据
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L13-L35)

**Section sources**
- [dataService.js](file://src/services/dataService.js#L13-L35)

#### 数据导入功能
```mermaid
flowchart TD
Start([开始导入]) --> Validate["验证数据格式"]
Validate --> FormatValid{"格式有效?"}
FormatValid --> |否| ReturnError["抛出格式错误"]
FormatValid --> |是| CheckOptions["检查导入选项"]
CheckOptions --> ClearExisting{"清除现有数据?"}
ClearExisting --> |是| ClearDB["清除IndexedDB"]
ClearExisting --> |否| ProcessData["处理数据导入"]
ClearDB --> ProcessData
ProcessData --> LoopStart["遍历导入数据"]
LoopStart --> GetData["获取键值对"]
GetData --> CheckMerge{"合并模式?"}
CheckMerge --> |是| CheckArray{"数组类型?"}
CheckMerge --> |否| DirectSet["直接存储"]
CheckArray --> |是| CheckKey{"键为TODO_*?"}
CheckArray --> |否| DirectSet
CheckKey --> |是| MergeById["按ID合并去重"]
CheckKey --> |否| DirectSet
MergeById --> DirectSet
DirectSet --> IDB["存储到IndexedDB"]
IDB --> NextData["下一个数据"]
NextData --> LoopEnd{"所有数据处理完毕?"}
LoopEnd --> |否| GetData
LoopEnd --> |是| ReturnSuccess["返回成功结果"]
ReturnError --> End([结束])
ReturnSuccess --> End
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L46-L86)

**Section sources**
- [dataService.js](file://src/services/dataService.js#L46-L86)

#### 智能数据合并
```mermaid
classDiagram
class DataService {
+static mergeArrayData(existingData, newData, key) Object
}
class ArrayMerger {
+mergeById(existingData, newData) Object
+mergeByReplace(newData) Object
}
DataService --> ArrayMerger : "使用"
note right of DataService
对于TODO_CATEGORIES_KEY和TODO_ITEMS_KEY，
按ID去重合并；其他情况直接替换
end note
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L89-L99)

**Section sources**
- [dataService.js](file://src/services/dataService.js#L89-L99)

#### 文件系统API集成
```mermaid
sequenceDiagram
participant UI as "用户界面"
participant DS as "DataService"
participant FSA as "File System Access API"
participant Legacy as "传统下载方式"
UI->>DS : saveFileWithSystemAPI()
DS->>DS : 检查API支持
alt API支持
DS->>FSA : showSaveFilePicker()
FSA-->>DS : 文件句柄
DS->>FSA : createWritable()
DS->>FSA : write(blob)
FSA-->>DS : 写入完成
DS-->>UI : 保存成功
else API不支持或失败
DS->>Legacy : downloadAsJSON()
Legacy-->>UI : 触发下载
end
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js#L130-L173)

**Section sources**
- [dataService.js](file://src/services/dataService.js#L130-L173)

### idGenerator.js分析
idGenerator.js提供全局唯一的ID生成算法，确保不同数据实体的ID不会冲突，支持带前缀的ID生成以增强数据可读性。

```mermaid
classDiagram
class IdGenerator {
+static generateId() string
+static generateIdWithPrefix(prefix) string
+static isValidId(id) boolean
}
note right of IdGenerator
generateId : 时间戳 + 随机字符串<br/>
generateIdWithPrefix : 前缀 + "_" + generateId()
end note
```

**Diagram sources**
- [idGenerator.js](file://src/utils/idGenerator.js#L1-L31)

**Section sources**
- [idGenerator.js](file://src/utils/idGenerator.js#L1-L31)

### errorHandler.js分析
errorHandler.js实现统一的错误处理框架，提供用户友好的错误信息映射和错误日志记录功能，确保异常情况下的用户体验。

```mermaid
classDiagram
class ErrorHandler {
+ErrorTypes 枚举
+AppError 自定义错误类
+getUserFriendlyMessage(error) string
+withErrorHandling(fn, operation, type) Function
+logError(error, context) void
}
class ErrorTypes {
+NETWORK
+STORAGE
+VALIDATION
+BUSINESS
+UNKNOWN
}
ErrorHandler --> ErrorTypes
```

**Diagram sources**
- [errorHandler.js](file://src/utils/errorHandler.js#L1-L109)

**Section sources**
- [errorHandler.js](file://src/utils/errorHandler.js#L1-L109)

## 依赖分析
TidyDo的数据持久化组件之间存在明确的依赖关系，DataService依赖于具体的业务服务，而业务服务又依赖于通用工具模块。

```mermaid
graph TD
DS[dataService.js] --> TS[todoService.js]
DS --> STS[simpleTodoService.js]
TS --> IG[idGenerator.js]
TS --> EH[errorHandler.js]
STS --> IG
STS --> EH
TS --> IDB[idb-keyval]
STS --> IDB
DS --> IDB
style DS fill:#4CAF50,stroke:#388E3C
style TS fill:#2196F3,stroke:#1976D2
style STS fill:#2196F3,stroke:#1976D2
style IG fill:#FF9800,stroke:#F57C00
style EH fill:#9C27B0,stroke:#7B1FA2
style IDB fill:#FFCDD2,stroke:#D32F2F
```

**Diagram sources**
- [dataService.js](file://src/services/dataService.js)
- [todoService.js](file://src/services/todoService.js)
- [simpleTodoService.js](file://src/services/simpleTodoService.js)
- [idGenerator.js](file://src/utils/idGenerator.js)
- [errorHandler.js](file://src/utils/errorHandler.js)

**Section sources**
- [dataService.js](file://src/services/dataService.js)
- [todoService.js](file://src/services/todoService.js)
- [simpleTodoService.js](file://src/services/simpleTodoService.js)

## 性能考虑
TidyDo的数据持久化设计考虑了多项性能优化策略，包括批量操作、数据压缩和错误处理优化。

### 存储键设计规范
TidyDo采用统一的存储键命名规范，确保数据组织的清晰性和可维护性。

| 存储键 | 用途 | 数据类型 |
|-------|------|---------|
| todo-categories | 存储分类数据 | 数组 |
| todo-items | 存储待办事项数据 | 数组 |
| simple-todo-items | 存储简单待办事项数据 | 数组 |

**Section sources**
- [todoService.js](file://src/services/todoService.js#L3-L4)
- [simpleTodoService.js](file://src/services/simpleTodoService.js#L5)

### 数据完整性校验
系统在数据导入时执行严格的完整性校验，确保数据格式的正确性。

```mermaid
flowchart TD
Start([开始导入]) --> CheckData["检查数据对象"]
CheckData --> HasData{"包含data属性?"}
HasData --> |否| ThrowError["抛出格式错误"]
HasData --> |是| CheckClear["检查清除选项"]
CheckClear --> CheckMerge["检查合并选项"]
CheckMerge --> ProcessData["处理数据"]
ProcessData --> Success["返回成功"]
ThrowError --> Fail["返回失败"]
```

**Section sources**
- [dataService.js](file://src/services/dataService.js#L50-L53)

## 故障排除指南
本节提供常见数据持久化问题的解决方案和恢复指南。

### 浏览器存储限制应对
当遇到存储空间不足时，系统提供相应的错误处理和用户提示。

```mermaid
flowchart TD
Start([存储操作]) --> Operation["执行操作"]
Operation --> Success{"成功?"}
Success --> |是| End["完成"]
Success --> |否| CheckError["检查错误类型"]
CheckError --> QuotaExceeded{"配额超出?"}
QuotaExceeded --> |是| UserMessage["提示: 存储空间不足"]
QuotaExceeded --> |否| GenericError["一般错误处理"]
UserMessage --> SuggestClear["建议清理浏览器数据"]
GenericError --> LogError["记录错误日志"]
```

**Section sources**
- [errorHandler.js](file://src/utils/errorHandler.js#L58-L62)

### 灾难恢复指南
提供完整的数据恢复流程，确保用户数据安全。

1. **数据导出**：定期使用`DataService.exportAllData()`导出数据
2. **文件保存**：通过`saveFileWithSystemAPI`保存为JSON文件
3. **数据恢复**：使用`importData`方法导入备份文件
4. **验证数据**：检查导入后的数据完整性

**Section sources**
- [dataService.js](file://src/services/dataService.js#L13-L273)

## 结论
TidyDo的数据持久化架构设计合理，功能完整，通过模块化设计实现了高内聚低耦合。系统提供了完善的数据备份恢复机制，结合现代浏览器API和传统方式，确保了良好的用户体验和数据安全性。建议定期备份重要数据，并关注浏览器存储限制，以确保应用的稳定运行。