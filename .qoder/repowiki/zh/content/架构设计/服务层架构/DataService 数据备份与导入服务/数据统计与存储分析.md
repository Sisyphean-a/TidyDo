# 数据统计与存储分析

<cite>
**Referenced Files in This Document**   
- [src/services/dataService.js](file://src/services/dataService.js)
- [src/stores/useReportStore.js](file://src/stores/useReportStore.js)
- [src/model/ConfigDialog.vue](file://src/model/ConfigDialog.vue)
- [src/views/tidyDo/components/TodoReport.vue](file://src/views/tidyDo/components/TodoReport.vue)
</cite>

## 目录
1. [getDataStats方法详解](#getdatastats方法详解)
2. [数据统计应用场景](#数据统计应用场景)
3. [useReportStore中的统计信息应用](#usereportstore中的统计信息应用)
4. [性能监控与数据清理建议](#性能监控与数据清理建议)

## getDataStats方法详解

`getDataStats`方法是`DataService`类中的一个静态异步方法，负责扫描IndexedDB中的所有条目并生成详细的存储统计信息。该方法通过`idb-keyval`库提供的`keys()`和`get()`函数，遍历所有存储的键值对，分析每个数据项的类型和大小。

方法首先获取所有存储键，然后对每个键对应的值进行类型判断：
- 对于数组类型的数据，统计其元素数量
- 对于对象类型的数据，统计其属性数量
- 对于基本类型的数据，记录其类型和值

```mermaid
flowchart TD
Start([开始获取数据统计]) --> GetKeys["获取所有存储键\nawait keys()"]
GetKeys --> InitStats["初始化统计对象\n{totalKeys, details}"]
InitStats --> LoopStart{遍历所有键}
LoopStart --> GetValue["获取键对应值\nawait get(key)"]
GetValue --> CheckType{判断值类型}
CheckType --> |Array| HandleArray["记录数组类型\ncount: value.length"]
CheckType --> |Object| HandleObject["记录对象类型\nkeys: Object.keys(value).length"]
CheckType --> |Basic| HandleBasic["记录基本类型\ntype, value"]
HandleArray --> UpdateDetails
HandleObject --> UpdateDetails
HandleBasic --> UpdateDetails
UpdateDetails["更新details对象"] --> LoopEnd{是否遍历完所有键}
LoopEnd --> |否| LoopStart
LoopEnd --> |是| ReturnStats["返回统计结果"]
ReturnStats --> End([结束])
style Start fill:#4CAF50,stroke:#388E3C
style End fill:#4CAF50,stroke:#388E3C
style ReturnStats fill:#2196F3,stroke:#1976D2
```

**Diagram sources**
- [src/services/dataService.js](file://src/services/dataService.js#L239-L272)

**Section sources**
- [src/services/dataService.js](file://src/services/dataService.js#L239-L272)

## 数据统计应用场景

`getDataStats`方法在用户诊断数据异常或评估存储占用时具有重要应用价值。通过提供详细的存储统计信息，用户可以：

1. **诊断数据异常**：当应用程序出现性能问题或数据不一致时，用户可以通过查看数据统计来识别异常的数据项。例如，某个分类的待办事项数量异常增多，可能表明存在数据重复或逻辑错误。

2. **评估存储占用**：用户可以了解不同类型数据的存储情况，识别占用空间较大的数据项。这对于管理存储空间、优化数据结构和制定备份策略至关重要。

3. **数据管理决策**：在配置对话框中，数据统计信息以可视化的方式展示，帮助用户做出数据管理决策。用户可以清楚地看到"待办分类"、"待办事项"和"应用配置"等关键数据项的数量和类型。

```mermaid
graph TD
A[数据统计应用场景] --> B[诊断数据异常]
A --> C[评估存储占用]
A --> D[数据管理决策]
B --> B1[识别数据重复]
B --> B2[发现逻辑错误]
B --> B3[定位性能瓶颈]
C --> C1[识别大容量数据项]
C --> C2[优化数据结构]
C --> C3[制定备份策略]
D --> D1[决定数据清理]
D --> D2[调整存储策略]
D --> D3[规划系统升级]
```

**Diagram sources**
- [src/model/ConfigDialog.vue](file://src/model/ConfigDialog.vue#L170-L198)

**Section sources**
- [src/model/ConfigDialog.vue](file://src/model/ConfigDialog.vue#L170-L198)

## useReportStore中的统计信息应用

`useReportStore`是基于Pinia的状态管理模块，它利用`getDataStats`提供的统计信息来支持高级分析功能。该store不仅管理报表数据的响应式状态，还提供了丰富的计算属性和方法来处理和展示统计信息。

`useReportStore`通过以下方式整合和应用统计信息：

1. **响应式状态管理**：store使用`ref`和`computed`创建响应式状态，确保统计信息的实时更新和自动计算。

2. **高级分析功能**：store提供了多种计算属性，如`projectCountStats`、`statusDistributionStats`、`completionStats`等，将原始数据转化为有意义的分析指标。

3. **数据可视化支持**：store为前端组件提供结构化的数据，支持各种图表的渲染，包括饼图、柱状图、折线图和仪表盘。

```mermaid
classDiagram
class useReportStore {
+isLoading : ref<boolean>
+reportData : ref<Object>
+lastUpdated : ref<string>
+trendDays : ref<number>
+autoRefresh : ref<boolean>
+refreshInterval : ref<number>
+projectCountStats : computed
+statusDistributionStats : computed
+completionStats : computed
+timeTrendStats : computed
+priorityDistributionStats : computed
+hasData : computed
+isDataStale : computed
+formattedLastUpdated : computed
+loadReportData(options) : Promise<void>
+refreshReportData() : Promise<void>
+setTrendDays(days) : void
+startAutoRefresh(intervalMinutes) : void
+stopAutoRefresh() : void
+getSpecificStats(type) : Promise<Object>
+clearReportData() : void
+resetState() : void
+exportReportData(format) : Object
}
class TodoReport {
+selectedTrendDays : ref<number>
+trendDaysOptions : Array<Object>
+statusChartRef : ref<HTMLElement>
+categoryChartRef : ref<HTMLElement>
+trendChartRef : ref<HTMLElement>
+gaugeChartRef : ref<HTMLElement>
+priorityChartRef : ref<HTMLElement>
+handleRefresh() : void
+handleTrendDaysChange(days) : void
+handleExport() : void
+initializeCharts() : void
+initializeStatusChart() : void
+initializeCategoryChart() : void
+initializeTrendChart() : void
+initializeGaugeChart() : void
+initializePriorityChart() : void
}
useReportStore --> TodoReport : "提供数据"
TodoReport --> useReportStore : "调用方法"
```

**Diagram sources**
- [src/stores/useReportStore.js](file://src/stores/useReportStore.js#L9-L247)
- [src/views/tidyDo/components/TodoReport.vue](file://src/views/tidyDo/components/TodoReport.vue#L285-L333)

**Section sources**
- [src/stores/useReportStore.js](file://src/stores/useReportStore.js#L9-L247)
- [src/views/tidyDo/components/TodoReport.vue](file://src/views/tidyDo/components/TodoReport.vue#L285-L333)

## 性能监控与数据清理建议

为了确保应用程序的长期稳定运行，建议实施以下性能监控和数据清理策略：

### 定期检查数据膨胀情况

1. **设置监控周期**：建议每周或每月定期检查数据统计，关注关键数据项的增长趋势。

2. **建立基线**：记录初始数据量作为基线，便于后续比较和识别异常增长。

3. **设置预警阈值**：当某个数据项的数量超过预设阈值时，系统应发出警告。

### 数据清理最佳实践

1. **定期归档**：将已完成的待办事项归档，减少活跃数据集的大小。

2. **清理无效数据**：定期检查并删除不再需要的分类、配置或临时数据。

3. **优化数据结构**：根据使用模式优化数据结构，例如将频繁访问的小数据项合并存储。

4. **实施数据保留策略**：为不同类型的数据设置合理的保留期限，自动清理过期数据。

```mermaid
flowchart TD
A[性能监控与数据清理] --> B[定期检查]
A --> C[数据清理]
B --> B1[设置监控周期]
B --> B2[建立基线]
B --> B3[设置预警阈值]
C --> C1[定期归档]
C --> C2[清理无效数据]
C --> C3[优化数据结构]
C --> C4[实施数据保留策略]
B1 --> D[每周/每月检查]
B2 --> D
B3 --> D
C1 --> E[归档已完成事项]
C2 --> E
C3 --> E
C4 --> E
D --> F[生成监控报告]
E --> G[执行清理操作]
F --> H[评估系统性能]
G --> H
H --> I{是否需要优化?}
I --> |是| J[调整策略]
I --> |否| K[维持现状]
J --> B
J --> C
```

**Diagram sources**
- [src/services/dataService.js](file://src/services/dataService.js#L239-L272)
- [src/model/ConfigDialog.vue](file://src/model/ConfigDialog.vue#L170-L198)

**Section sources**
- [src/services/dataService.js](file://src/services/dataService.js#L239-L272)
- [src/model/ConfigDialog.vue](file://src/model/ConfigDialog.vue#L170-L198)